from fastapi import APIRouter, HTTPExceptionfrom app.models.user import UserCreate, UserResponsefrom app.services.mongo_service import (    create_user,     get_user_by_username,    follow_user,    unfollow_user)router = APIRouter(prefix="/users", tags=["users"])@router.post("/", response_model=dict)async def api_create_user(user: UserCreate):    """Создание нового пользователя"""    existing = get_user_by_username(user.username)    if existing:        raise HTTPException(status_code=400, detail="Username уже занят")        user_id = create_user(user.dict())    return {"message": "Пользователь создан", "id": user_id}@router.get("/{username}", response_model=UserResponse)async def api_get_user(username: str):    """Получение пользователя"""    user = get_user_by_username(username)    if not user:        raise HTTPException(status_code=404, detail="Пользователь не найден")        user["_id"] = str(user["_id"])    user["followers_count"] = len(user.get("followers", []))    user["following_count"] = len(user.get("following", []))    return user@router.post("/{username}/follow/{target_username}")async def api_follow_user(username: str, target_username: str):    """Подписаться на пользователя"""    user = get_user_by_username(username)    target = get_user_by_username(target_username)        if not user or not target:        raise HTTPException(status_code=404, detail="Пользователь не найден")        if target_username in user.get("following", []):        raise HTTPException(status_code=400, detail="Вы уже подписаны")        success = follow_user(str(user["_id"]), str(target["_id"]))    if success:        return {"message": f"Подписались на {target_username}"}    else:        raise HTTPException(status_code=500, detail="Ошибка при подписке")@router.delete("/{username}/unfollow/{target_username}")async def api_unfollow_user(username: str, target_username: str):    """Отписаться от пользователя"""    user = get_user_by_username(username)    target = get_user_by_username(target_username)        if not user or not target:        raise HTTPException(status_code=404, detail="Пользователь не найден")        if target_username not in user.get("following", []):        raise HTTPException(status_code=400, detail="Вы не подписаны на этого пользователя")        success = unfollow_user(str(user["_id"]), str(target["_id"]))    if success:        return {"message": f"Отписались от {target_username}"}    else:        raise HTTPException(status_code=500, detail="Ошибка при отписке")