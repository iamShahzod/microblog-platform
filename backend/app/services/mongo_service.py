from pymongo import MongoClientfrom bson import ObjectIdfrom datetime import datetimefrom typing import List, Dict, Anyclient = MongoClient("mongodb://localhost:27017")db = client["microblog"]users_collection = db["users"]posts_collection = db["posts"]# ========== ПОЛЬЗОВАТЕЛИ ==========def create_user(user_data: dict) -> str:    """Создает нового пользователя"""    user_data["created_at"] = datetime.utcnow()    user_data["followers"] = []    user_data["following"] = []        result = users_collection.insert_one(user_data)    return str(result.inserted_id)def get_user_by_username(username: str) -> Dict[str, Any]:    """Находит пользователя по имени"""    return users_collection.find_one({"username": username})def get_user_by_id(user_id: str) -> Dict[str, Any]:    """Находит пользователя по ID"""    try:        return users_collection.find_one({"_id": ObjectId(user_id)})    except:        return Nonedef follow_user(user_id: str, target_user_id: str) -> bool:    """Подписаться на пользователя"""    # Добавляем в following    users_collection.update_one(        {"_id": ObjectId(user_id)},        {"$addToSet": {"following": target_user_id}}    )    # Добавляем в followers    users_collection.update_one(        {"_id": ObjectId(target_user_id)},        {"$addToSet": {"followers": user_id}}    )    return Truedef unfollow_user(user_id: str, target_user_id: str) -> bool:    """Отписаться от пользователя"""    # Удаляем из following    users_collection.update_one(        {"_id": ObjectId(user_id)},        {"$pull": {"following": target_user_id}}    )    # Удаляем из followers    users_collection.update_one(        {"_id": ObjectId(target_user_id)},        {"$pull": {"followers": user_id}}    )    return True# ========== ПОСТЫ ==========def create_post(post_data: dict) -> str:    """Создает новый пост"""    post_data["created_at"] = datetime.utcnow()    post_data["likes"] = []        result = posts_collection.insert_one(post_data)    return str(result.inserted_id)def get_post_by_id(post_id: str) -> Dict[str, Any]:    """Находит пост по ID"""    try:        return posts_collection.find_one({"_id": ObjectId(post_id)})    except:        return Nonedef like_post(post_id: str, user_id: str) -> bool:    """Добавляет лайк к посту"""    posts_collection.update_one(        {"_id": ObjectId(post_id)},        {"$addToSet": {"likes": user_id}}    )    return Truedef get_posts_by_user(user_id: str, limit: int = 50) -> List[Dict[str, Any]]:    """Получает посты пользователя"""    posts = posts_collection.find(        {"user_id": user_id}    ).sort("created_at", -1).limit(limit)    return list(posts)def get_feed_from_db(user_id: str, limit: int = 50) -> List[Dict[str, Any]]:    """Получает ленту из БД (посты от пользователей, на которых подписан)"""    user = get_user_by_id(user_id)    if not user or not user.get("following"):        return []        following = user["following"]    posts = posts_collection.find(        {"user_id": {"$in": following}}    ).sort("created_at", -1).limit(limit)    return list(posts)